<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FitLife Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
:root{
  --primary:#1a2a6c;
  --secondary:#b21f1f;
  --accent:#fdbb2d;
  --card-bg: rgba(255,255,255,0.85);
  --sidebar-width: 240px;
  --gap: 20px;
  --radius: 12px;
  --max-content-width: 1200px;
}

/* Base layout */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  background: linear-gradient(135deg,var(--primary),var(--secondary),var(--accent));
  color:#fff;
  display:flex;
  justify-content:center;
  padding:20px;
}
.dashboard-container{
  display:flex;
  width:100%;
  max-width:var(--max-content-width);
  gap:var(--gap);
  align-items:flex-start;
}

/* Sidebar */
.sidebar{
  width:var(--sidebar-width);
  background: linear-gradient(to bottom,var(--primary),var(--secondary));
  padding:20px;
  height:calc(100vh - 40px);
  box-shadow:2px 0 15px rgba(0,0,0,0.2);
  border-radius:0 20px 20px 0;
  display:flex;
  flex-direction:column;
  position:sticky;
  top:20px;
}
.sidebar-header h3{text-align:center;margin-bottom:20px;font-size:1.25rem;letter-spacing:1px;}
.nav-menu{list-style:none;padding:0;margin:0;flex:1;display:flex;flex-direction:column;gap:10px;}
.nav-item{
  padding:12px;
  border-radius:12px;
  display:flex;
  align-items:center;
  gap:12px;
  cursor:pointer;
  transition:all .22s ease;
  font-weight:600;
  color: #fff;
  background: transparent;
}
.nav-item i{font-size:1.1rem; width:20px; text-align:center}
.nav-item:hover,.nav-item.active{background: rgba(255,255,255,0.08); transform: translateX(6px); box-shadow: 0 6px 16px rgba(0,0,0,0.2);}

/* Main content */
.main-content{
  flex:1;
  padding:10px;
  overflow-y:auto;
  min-width:0;
}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(10px);
  padding:12px 14px;
  border-radius:12px;
  box-shadow:0 8px 20px rgba(0,0,0,0.18);
  margin-bottom:18px;
}
.user-profile{
  display:flex;
  align-items:center;
  gap:12px;
  background: rgba(255,255,255,0.03);
  padding:6px 10px;
  border-radius:10px;
}
.user-profile h4{margin:0;font-size:1rem;line-height:1}
.user-profile p{margin:0;font-size:0.75rem;color:#fff;opacity:0.9}
.logout-btn{background: var(--secondary);color:#fff;border:none;border-radius:8px;padding:6px 10px;font-weight:600;cursor:pointer;}

/* ADD: sidebar toggle button (hidden on desktop) */
.sidebar-toggle{display:none;border:0;background:transparent;color:#fff;font-size:1.1rem;padding:6px;cursor:pointer;border-radius:8px}

/* Cards and sections */
.stats-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
  margin-bottom:20px;
}
.stat-card{
  background: linear-gradient(135deg,var(--accent),var(--secondary));
  color:#fff;border-radius:16px;padding:18px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,0.18);
}
.stat-icon{font-size:1.6rem;margin-bottom:8px}
.stat-number{font-size:1.6rem;font-weight:700}
.stat-label{font-size:0.9rem;opacity:0.95}

/* Sections */
.section{
  display:none;
  background: var(--card-bg);
  padding:18px;
  border-radius:14px;
  box-shadow:0 8px 20px rgba(0,0,0,0.12);
  color:#222;
}
.section h2{margin-top:0;color:var(--primary);font-size:1.25rem;margin-bottom:12px}

/* Workouts */
.workout-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:14px;
}
.workout-card{
  background: linear-gradient(135deg,#ff9a9e,#fad0c4);
  padding:10px;border-radius:12px;box-shadow:0 6px 15px rgba(0,0,0,0.12);color:#fff;text-align:center;
}
.workout-card h3{font-size:0.95rem;margin:6px 0}
.workout-gif{width:100%;height:110px;object-fit:cover;border-radius:8px;}

/* Lists */
#nutritionList li,#progressContent p{
  background: rgba(255,255,255,0.12); padding:12px 15px; border-radius:10px; margin-bottom:10px; color:#222;
}

/* Utility */
.start-btn,.done-btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
.start-btn{background:linear-gradient(45deg,#43cea2,#185a9d);color:#fff}
.done-btn{background:linear-gradient(45deg,#ff416c,#ff4b2b);color:#fff}

/* Responsive adjustments */
@media (max-width:1100px){
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .sidebar{height:auto;position:relative;top:0;border-radius:12px;}
  .dashboard-container{align-items:stretch}
}
/* ADD: mobile sidebar hidden by default, shown when .open */
@media (max-width:800px){
  /* stack layout */
  .dashboard-container{flex-direction:column;gap:12px}
  .sidebar{
    position:fixed;
    left:0; top:0; bottom:0;
    width:var(--sidebar-width);
    transform:translateX(-110%);
    transition:transform .28s ease;
    z-index:1002;
    height:100%;
    border-radius:0 12px 12px 0;
    box-shadow:2px 0 20px rgba(0,0,0,0.45);
  }
  .sidebar.open{ transform:translateX(0); }
  .nav-menu{flex-direction:column;gap:8px;overflow:auto}
  .sidebar-toggle{display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,0.06);color:#fff;border:none;cursor:pointer}
  /* overlay to dim page when sidebar open */
  #overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.45); opacity:0; visibility:hidden; transition:opacity .2s ease; z-index:1001}
  #overlay.show{ opacity:1; visibility:visible }
  .main-content{padding:6px}
  .header{flex-direction:column;align-items:flex-start;gap:8px}
  .user-profile{width:100%;justify-content:space-between}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .workout-gif{height:90px}
}
@media (max-width:480px){
  .stats-grid{grid-template-columns:1fr;gap:12px}
  .workout-grid{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
  .header{padding:10px}
  .user-profile h4{font-size:0.95rem}
  .sidebar{padding:8px}
  .nav-item i{display:none}
  .nav-item{padding:8px;border-radius:8px;font-size:0.88rem}
  .workout-gif{height:80px}
}

/* small visual tweaks for high density screens */
@media (min-width:1400px){
  .stat-card{padding:26px}
  .workout-gif{height:140px}
}
</style>
</head>
<body>
<div class="dashboard-container">
<nav class="sidebar">
  <div class="sidebar-header"><h3>FitLife Menu</h3></div>
  <ul class="nav-menu">
    <li class="nav-item active" data-section="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</li>
    <li class="nav-item" data-section="workouts"><i class="fas fa-dumbbell"></i> Workouts</li>
    <li class="nav-item" data-section="nutrition"><i class="fas fa-apple-alt"></i> Nutrition</li>
    <li class="nav-item" data-section="progress"><i class="fas fa-chart-line"></i> Progress</li>
    <li class="nav-item" data-section="profile"><i class="fas fa-user"></i> Profile</li>
  </ul>
  <!-- ADD: sidebar toggle button (hidden on desktop) -->
  <button class="sidebar-toggle" aria-label="Toggle menu">
    <i class="fas fa-bars"></i>
  </button>
</nav>

<main class="main-content">
<header class="header">
  <div style="display:flex;align-items:center;gap:12px;">
    <button id="sidebarToggle" class="sidebar-toggle" aria-label="Toggle menu"><i class="fas fa-bars"></i></button>
    <img src="https://seeklogo.com/images/F/fit-life-logo-B9A7A4B092-seeklogo.com.png" alt="FitLife Logo" style="height:48px;">
  </div>
  <div class="user-profile">
    <div id="userAvatar" style="width:40px;height:40px;border-radius:50%;background:#eee;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.3rem;">J</div>
    <div class="user-info">
      <h4 id="userName">John Doe</h4>
      <p id="userEmail">john@example.com</p>
    </div>
    <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
  </div>
</header>
<!-- ADD overlay element -->
<div id="overlay" aria-hidden="true"></div>

<div id="dashboard" class="section" style="display:block;">
  <div class="stats-grid">
    <div class="stat-card"><div class="stat-icon"><i class="fas fa-dumbbell"></i></div><div class="stat-number" id="workoutsCompleted">0</div><div class="stat-label">Workouts Completed</div></div>
    <div class="stat-card"><div class="stat-icon"><i class="fas fa-fire"></i></div><div class="stat-number">1250</div><div class="stat-label">Calories Burned</div></div>
    <div class="stat-card"><div class="stat-icon"><i class="fas fa-trophy"></i></div><div class="stat-number">65%</div><div class="stat-label">Goal Progress</div></div>
  </div>
</div>

<div id="workouts" class="section"><h2>Workouts</h2>
<div id="workoutList" class="workout-grid"></div>
</div>

<div id="nutrition" class="section">
  <h2>Nutrition</h2>

  <!-- AI nutrition form -->
  <div id="ai-nutrition" style="margin-bottom:12px;">
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-bottom:8px;">
      <input id="ai-age" placeholder="Age" />
      <select id="ai-sex">
        <option value="">Sex</option>
        <option value="male">Male</option>
        <option value="female">Female</option>
        <option value="other">Other</option>
      </select>
      <input id="ai-weight" placeholder="Weight (kg)" />
      <input id="ai-height" placeholder="Height (cm)" />
      <select id="ai-activity">
        <option value="">Activity</option>
        <option value="sedentary">Sedentary</option>
        <option value="light">Light</option>
        <option value="moderate">Moderate</option>
        <option value="active">Active</option>
      </select>
      <select id="ai-goal">
        <option value="">Goal</option>
        <option value="lose">Lose weight</option>
        <option value="maintain">Maintain</option>
        <option value="gain">Gain muscle</option>
      </select>
      <input id="ai-meals" placeholder="Meals per day (e.g. 3)" />
    </div>

    <textarea id="ai-preferences" placeholder="Dietary preferences / allergies / dislikes" style="width:100%;min-height:80px;margin-bottom:8px;"></textarea>

    <div style="display:flex;gap:8px;">
      <button id="generateDietBtn" class="start-btn">Generate AI Diet</button>
      <button id="clearDietBtn" class="done-btn">Clear</button>
      <div id="nutrition-loading" style="opacity:0;transition:opacity .2s ease;margin-left:8px;align-self:center;">Loading...</div>
    </div>

    <pre id="aiDietResult" style="white-space:pre-wrap;background:rgba(0,0,0,0.05);padding:12px;border-radius:8px;margin-top:10px;color:#111;display:none;"></pre>
    <p id="aiDietError" class="error" style="display:none"></p>
  </div>

  <!-- Keep non-AI nutrition UI (manual meal list / localStorage) if present -->
  <!-- ...existing nutrition UI... -->
</div>

<div id="progress" class="section"><h2>Progress</h2>
<div id="progressContent">
<p>Goal: Weight Loss</p>
<p>Progress: 65%</p>
<p>Next target: Lose 2 kg</p>
</div>
</div>

<div id="profile" class="section"><h2>Profile</h2><p>Update your profile here.</p></div>
</main>
</div>

<!-- add Firebase SDKs (place before the script below) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

<script>
  // Firebase config (reuse same config from login.html)
  const firebaseConfig = {
    apiKey: "AIzaSyCYOzxUWAPd4ifIKUOXY0TQQvWJStRaeYk",
    authDomain: "fitlife-8e768.firebaseapp.com",
    projectId: "fitlife-8e768",
    storageBucket: "fitlife-8e768.appspot.com",
    messagingSenderId: "721770808033",
    appId: "1:721770808033:web:adb64336eb674c3679eda0",
    measurementId: "G-BLNN73G7VK"
  };

  // initialize only if not already initialized
  if (window.firebase === undefined || !firebase.apps || firebase.apps.length === 0) {
    firebase.initializeApp(firebaseConfig);
  }
  const auth = firebase.auth();

  // Populate UI from authenticated user instead of prompt()
  auth.onAuthStateChanged(user => {
    if (!user) {
      // not signed in -> redirect to login page
      window.location.href = 'login.html';
      return;
    }

    const nameEl = document.getElementById("userName");
    const emailEl = document.getElementById("userEmail");
    const avatar = document.getElementById("userAvatar");

    const displayName = user.displayName || '';
    const email = user.email || '';

    if (nameEl) nameEl.textContent = displayName || email || 'User';
    if (emailEl) emailEl.textContent = email;
    if (avatar) avatar.textContent = (displayName ? displayName.charAt(0).toUpperCase() : (email ? email.charAt(0).toUpperCase() : 'U'));
  });

  // Section switching (keep existing behavior)
  const navItems = document.querySelectorAll('.nav-item');
  const sections = {
    dashboard: document.getElementById('dashboard'),
    workouts: document.getElementById('workouts'),
    nutrition: document.getElementById('nutrition'),
    progress: document.getElementById('progress'),
    profile: document.getElementById('profile')
  };
  navItems.forEach(item => item.addEventListener('click', () => {
    navItems.forEach(i => i.classList.remove('active'));
    item.classList.add('active');
    Object.keys(sections).forEach(k => sections[k].style.display = k === item.dataset.section ? 'block' : 'none');
  }));

  // Sidebar toggle behavior
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.getElementById('overlay');
  const toggleBtn = document.getElementById('sidebarToggle');

  function openSidebar() {
    sidebar.classList.add('open');
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden';
  }
  function closeSidebar() {
    sidebar.classList.remove('open');
    overlay.classList.remove('show');
    document.body.style.overflow = '';
  }

  if (toggleBtn) toggleBtn.addEventListener('click', (e) => {
    e.preventDefault();
    if (sidebar.classList.contains('open')) closeSidebar();
    else openSidebar();
  });

  if (overlay) overlay.addEventListener('click', closeSidebar);

  // close sidebar on nav item click (mobile)
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
      // existing nav behaviour
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      Object.keys(sections).forEach(k => sections[k].style.display = k === item.dataset.section ? 'block' : 'none');
      if (window.innerWidth <= 800) closeSidebar();
    });
  });

  // ensure sidebar closed on resize to desktop
  window.addEventListener('resize', () => {
    if (window.innerWidth > 800) {
      sidebar.classList.remove('open');
      overlay.classList.remove('show');
      document.body.style.overflow = '';
    }
  });

  // ensure firebase auth is available: const auth = firebase.auth();

  async function logout() {
    const btns = document.querySelectorAll('.logout-btn');
    btns.forEach(b => b.disabled = true);
    try {
      await auth.signOut();
      // absolute redirect so Vercel resolves correctly
      window.location.href = `${window.location.origin}/login.html`; // or use '/' if your app uses index.html as the login
    } catch (err) {
      console.error('Sign out error', err);
      btns.forEach(b => b.disabled = false);
    }
  }

  // wire any logout buttons (removes need for inline onclick)
  document.querySelectorAll('.logout-btn').forEach(btn => {
    btn.addEventListener('click', (e) => { e.preventDefault(); logout(); });
  });

  // Workouts Data
  const workoutsData = [
    { name: "Full Body Strength", gif: "https://i.gifer.com/7efs.gif" },
    { name: "Cardio Run", gif: "https://i.gifer.com/7vH9.gif" },
    { name: "Push Ups", gif: "https://i.gifer.com/7vG3.gif" },
    { name: "Squats", gif: "https://i.gifer.com/7fXY.gif" },
    { name: "Plank", gif: "https://i.gifer.com/7fZ4.gif" },
    { name: "Lunges", gif: "https://i.gifer.com/7gT1.gif" },
    { name: "Bicep Curls", gif: "https://i.gifer.com/7hG7.gif" },
    { name: "Tricep Dips", gif: "https://i.gifer.com/7hH8.gif" },
    { name: "Mountain Climbers", gif: "https://i.gifer.com/7hL9.gif" },
    { name: "Burpees", gif: "https://i.gifer.com/7hP0.gif" }
  ];

  const workoutList = document.getElementById('workoutList');

  workoutsData.forEach((workout, idx) => {
    let currentSet = 1;
    let timerInterval;

    const card = document.createElement('div');
    card.className = 'workout-card';

    const title = document.createElement('h3');
    title.textContent = `${workout.name} - Set ${currentSet}/3`;

    const img = document.createElement('img');
    img.src = workout.gif;
    img.className = 'workout-gif';

    const timerEl = document.createElement('div');
    timerEl.className = 'timer';
    timerEl.textContent = "Press Start";

    const startBtn = document.createElement('button');
    startBtn.className = 'start-btn';
    startBtn.textContent = "Start Set";

    const doneBtn = document.createElement('button');
    doneBtn.className = 'done-btn';
    doneBtn.textContent = "Complete Set";
    doneBtn.disabled = true;

    const btnContainer = document.createElement('div');
    btnContainer.appendChild(startBtn);
    btnContainer.appendChild(doneBtn);

    card.appendChild(title);
    card.appendChild(img);
    card.appendChild(timerEl);
    card.appendChild(btnContainer);
    workoutList.appendChild(card);

    function formatTime(sec){const m=Math.floor(sec/60);const s=sec%60;return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;}

    function startTimer(duration, callback){
      let time = duration;
      timerEl.textContent = formatTime(time);
      timerInterval = setInterval(()=>{
        time--;
        timerEl.textContent = formatTime(time);
        if(time<=0){clearInterval(timerInterval);callback();}
      },1000);
    }

    startBtn.onclick = ()=>{
      startBtn.disabled = true;
      doneBtn.disabled = false;
      startTimer(300, completeSet);
    };

    doneBtn.onclick = ()=>{
      clearInterval(timerInterval);
      completeSet();
    };

    function completeSet(){
      if(currentSet <3){
        timerEl.textContent = "1 min break";
        startBtn.disabled = true; doneBtn.disabled=true;
        setTimeout(()=>{
          currentSet++;
          title.textContent = `${workout.name} - Set ${currentSet}/3`;
          timerEl.textContent="Press Start";
          startBtn.disabled=false;
        },60000);
      }else{
        timerEl.textContent="Exercise Complete! 3 min break";
        startBtn.disabled=true; doneBtn.disabled=true;
        setTimeout(()=>{document.getElementById('workoutsCompleted').textContent=parseInt(document.getElementById('workoutsCompleted').textContent)+1;},180000);
      }
    }
  });

  // ensure auth is available: const auth = firebase.auth();

  async function getIdToken() {
    try {
      const user = firebase.auth().currentUser;
      if (!user) return null;
      return await user.getIdToken(false);
    } catch {
      return null;
    }
  }

  // Ensure no references remain to AI elements or functions:
  // ai-nutrition-form, generateDietBtn, saveDietBtn, aiDietResult, nutrition-loading
  // If any event listeners reference those IDs, remove them or guard with presence checks.
  // Example guard removal snippet:
  const maybeAiForm = document.getElementById('ai-nutrition-form');
  if (maybeAiForm) {
    maybeAiForm.remove(); // remove leftover element if present
  }
  // Also remove any global handlers created for AI (if present)
  if (window.loadNutrition) {
    // keep nutrition loader, but ensure it doesn't rely on AI
  }
</script>

<script>
  // AI nutrition client: wire Generate + Clear buttons
  (function(){
    const genBtn = document.getElementById('generateDietBtn');
    const clearBtn = document.getElementById('clearDietBtn');
    const loadingEl = document.getElementById('nutrition-loading');
    const resultEl = document.getElementById('aiDietResult');
    const errEl = document.getElementById('aiDietError');

    function showLoading(on){
      if (!loadingEl) return;
      loadingEl.style.opacity = on ? '1' : '0';
    }
    function showResult(text){
      if (!resultEl) return;
      resultEl.style.display = text ? 'block' : 'none';
      resultEl.textContent = text || '';
    }
    function showError(msg){
      if (!errEl) return;
      errEl.style.display = msg ? 'block' : 'none';
      errEl.textContent = msg || '';
    }

    genBtn?.addEventListener('click', async (e) => {
      e.preventDefault();
      showError('');
      showResult('');
      showLoading(true);
      genBtn.disabled = true;

      const payload = {
        age: document.getElementById('ai-age')?.value || '',
        sex: document.getElementById('ai-sex')?.value || '',
        weightKg: document.getElementById('ai-weight')?.value || '',
        heightCm: document.getElementById('ai-height')?.value || '',
        activity: document.getElementById('ai-activity')?.value || '',
        goal: document.getElementById('ai-goal')?.value || '',
        mealsPerDay: document.getElementById('ai-meals')?.value || '',
        preferences: document.getElementById('ai-preferences')?.value || ''
      };

      try {
        const res = await fetch('http://localhost:3000/api/diet-plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let json;
        try { json = text ? JSON.parse(text) : {}; } catch { json = null; }

        if (!res.ok) {
          const detail = (json && (json.error || json.detail)) || text || `Status ${res.status}`;
          showError(`Server error: ${detail}`);
        } else {
          const plan = (json && json.plan) || text || '';
          if (!plan) showError('Empty response from API');
          else showResult(plan);
        }
      } catch (err) {
        console.error(err);
        showError('Network error. Ensure the serverless function /api/diet-plan is deployed and environment key set.');
      } finally {
        showLoading(false);
        genBtn.disabled = false;
      }
    });

    clearBtn?.addEventListener('click', (e) => {
      e.preventDefault();
      ['ai-age','ai-sex','ai-weight','ai-height','ai-activity','ai-goal','ai-meals','ai-preferences']
        .forEach(id => { const el = document.getElementById(id); if (!el) return; if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = ''; });
      showResult('');
      showError('');
    });
  })();
</script>
</body>
</html>
