<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FitLife - Setup Your Profile</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    :root{
      --primary:#1a2a6c;
      --secondary:#b21f1f;
      --accent:#fdbb2d;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Poppins',sans-serif;
      background:linear-gradient(135deg,var(--primary),var(--secondary),var(--accent));
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
    }
    .onboarding-container{
      max-width:700px;
      width:100%;
      background:#fff;
      border-radius:16px;
      box-shadow:0 10px 40px rgba(0,0,0,0.2);
      padding:40px;
    }
    .progress-bar{
      width:100%;
      height:8px;
      background:rgba(26,42,108,0.1);
      border-radius:4px;
      margin-bottom:32px;
      overflow:hidden;
    }
    .progress-fill{
      height:100%;
      background:linear-gradient(90deg,var(--accent),var(--primary));
      transition:width .3s;
    }
    .step{display:none}
    .step.active{display:block;animation:fadeIn .4s}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    h1{color:var(--primary);margin-bottom:12px;font-size:1.8rem}
    p{color:#666;margin-bottom:28px;line-height:1.6}
    .goal-options{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px}
    .goal-card{
      padding:20px;
      border:3px solid rgba(26,42,108,0.2);
      border-radius:12px;
      cursor:pointer;
      transition:all .3s;
      text-align:center;
    }
    .goal-card:hover{border-color:var(--accent);transform:translateY(-4px);box-shadow:0 4px 16px rgba(0,0,0,0.1)}
    .goal-card.selected{border-color:var(--primary);background:rgba(26,42,108,0.08);box-shadow:0 4px 16px rgba(0,0,0,0.15)}
    .goal-card i{font-size:2.5rem;color:var(--primary);margin-bottom:12px;display:block}
    .goal-card h3{color:var(--primary);margin-bottom:6px;font-size:1.1rem}
    .goal-card p{color:#666;font-size:0.85rem;margin:0}
    .input-group{margin-bottom:20px}
    .input-group label{display:block;color:var(--primary);font-weight:600;margin-bottom:8px}
    .input-group input{
      width:100%;
      padding:14px;
      border:2px solid rgba(26,42,108,0.2);
      border-radius:10px;
      font-size:1rem;
      font-family:inherit;
      transition:all .3s;
    }
    .input-group input:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 4px rgba(253,187,45,0.2);
    }
    .button-group{display:flex;gap:12px;margin-top:32px}
    .btn{
      flex:1;
      padding:14px;
      border:none;
      border-radius:10px;
      font-size:1rem;
      font-weight:700;
      cursor:pointer;
      transition:all .3s;
      font-family:inherit;
    }
    .btn-primary{background:linear-gradient(135deg,var(--accent),var(--primary));color:#fff}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.2)}
    .btn-secondary{background:#e0e0e0;color:#666}
    .btn-secondary:hover{background:#d0d0d0}
    .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
    .welcome-icon{text-align:center;margin-bottom:24px}
    .welcome-icon i{font-size:4rem;color:var(--accent)}
    .error-message{color:#d9534f;font-size:0.9rem;margin-top:8px;min-height:1.2em}
    @media (max-width:600px){
      .onboarding-container{padding:28px 20px}
      h1{font-size:1.5rem}
      .goal-card{padding:16px}
      .goal-options{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="onboarding-container">
    <div class="progress-bar">
      <div class="progress-fill" id="progressBar" style="width:50%"></div>
    </div>

    <!-- Step 1: Welcome & Goal Selection -->
    <div class="step active" id="step1">
      <div class="welcome-icon">
        <i class="fas fa-fire"></i>
      </div>
      <h1>Welcome to FitLife!</h1>
      <p>Let's personalize your fitness journey. What's your primary goal?</p>
      
      <div class="goal-options">
        <div class="goal-card" data-goal="lose">
          <i class="fas fa-weight"></i>
          <h3>Lose Weight</h3>
          <p>Track weight loss progress</p>
        </div>
        <div class="goal-card" data-goal="maintain">
          <i class="fas fa-balance-scale"></i>
          <h3>Maintain Weight</h3>
          <p>Stay at current weight</p>
        </div>
        <div class="goal-card" data-goal="gain">
          <i class="fas fa-dumbbell"></i>
          <h3>Gain Muscle</h3>
          <p>Build strength and mass</p>
        </div>
      </div>

      <div class="error-message" id="goalError"></div>

      <div class="button-group">
        <button class="btn btn-primary" id="nextBtn1">
          Next <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>

    <!-- Step 2: Starting Weight -->
    <div class="step" id="step2">
      <div class="welcome-icon">
        <i class="fas fa-weight-hanging"></i>
      </div>
      <h1>What's Your Starting Weight?</h1>
      <p>We'll track your progress from here. You can add weekly updates later.</p>
      
      <div class="input-group">
        <label for="startingWeight"><i class="fas fa-balance-scale"></i> Starting Weight (kg)</label>
        <input type="number" id="startingWeight" placeholder="e.g., 75" step="0.1" min="20" max="300" required>
      </div>

      <div class="input-group">
        <label for="targetWeight"><i class="fas fa-bullseye"></i> Target Weight (kg) - Optional</label>
        <input type="number" id="targetWeight" placeholder="e.g., 70" step="0.1" min="20" max="300">
      </div>

      <div class="error-message" id="weightError"></div>

      <div class="button-group">
        <button class="btn btn-secondary" id="backBtn2">
          <i class="fas fa-arrow-left"></i> Back
        </button>
        <button class="btn btn-primary" id="finishBtn">
          Finish Setup <i class="fas fa-check"></i>
        </button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCYOzxUWAPd4ifIKUOXY0TQQvWJStRaeYk",
      authDomain: "fitlife-8e768.firebaseapp.com",
      projectId: "fitlife-8e768",
      storageBucket: "fitlife-8e768.appspot.com",
      messagingSenderId: "721770808033",
      appId: "1:721770808033:web:adb64336eb674c3679eda0"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();

    let selectedGoal = null;
    let currentUser = null;

    // Check if user is logged in
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      currentUser = user;
      
      // Check if already completed onboarding
      db.collection('users').doc(user.uid).get().then(doc => {
        if (doc.exists && doc.data().onboardingComplete) {
          window.location.href = 'dashboard.html';
        }
      });
    });

    // Goal selection
    document.querySelectorAll('.goal-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('.goal-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        selectedGoal = card.dataset.goal;
        document.getElementById('goalError').textContent = '';
      });
    });

    // Step navigation
    function showStep(stepNum) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById(`step${stepNum}`).classList.add('active');
      
      // Update progress bar
      const progress = stepNum === 1 ? 50 : 100;
      document.getElementById('progressBar').style.width = progress + '%';
    }

    document.getElementById('nextBtn1').addEventListener('click', () => {
      if (!selectedGoal) {
        document.getElementById('goalError').textContent = 'Please select a fitness goal';
        return;
      }
      showStep(2);
    });

    document.getElementById('backBtn2').addEventListener('click', () => {
      showStep(1);
    });

    // Finish onboarding
    document.getElementById('finishBtn').addEventListener('click', async () => {
      const startingWeight = parseFloat(document.getElementById('startingWeight').value);
      const targetWeight = parseFloat(document.getElementById('targetWeight').value) || null;

      if (!startingWeight || startingWeight < 20 || startingWeight > 300) {
        document.getElementById('weightError').textContent = 'Please enter a valid starting weight';
        return;
      }

      if (!currentUser) {
        alert('Please log in again');
        window.location.href = 'login.html';
        return;
      }

      try {
        document.getElementById('finishBtn').disabled = true;
        document.getElementById('finishBtn').textContent = 'Saving...';

        // Save user profile to Firestore
        await db.collection('users').doc(currentUser.uid).set({
          uid: currentUser.uid,
          email: currentUser.email,
          displayName: currentUser.displayName || '',
          fitnessGoal: selectedGoal,
          startingWeight: startingWeight,
          targetWeight: targetWeight,
          currentWeight: startingWeight,
          onboardingComplete: true,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Add first weight entry
        await db.collection('users').doc(currentUser.uid).collection('weightEntries').add({
          weight: startingWeight,
          date: new Date().toISOString().split('T')[0],
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Redirect to dashboard
        window.location.href = 'dashboard.html';
      } catch (error) {
        console.error('Error saving profile:', error);
        document.getElementById('weightError').textContent = 'Error saving profile. Please try again.';
        document.getElementById('finishBtn').disabled = false;
        document.getElementById('finishBtn').innerHTML = 'Finish Setup <i class="fas fa-check"></i>';
      }
    });
  </script>
</body>
</html>
